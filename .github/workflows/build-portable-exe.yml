name: Build Windows Portable EXE

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Portable EXE version (for example 1.2.3 or v1.2.3)"
        required: false
        default: ""
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-portable-exe:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Resolve version
        id: version
        shell: pwsh
        run: |
          $inputVersion = "${{ github.event.inputs.version }}"
          $tagVersion = "${{ github.ref_name }}"

          if (-not [string]::IsNullOrWhiteSpace($inputVersion)) {
            $resolved = $inputVersion
          } elseif ("${{ github.ref_type }}" -eq "tag" -and -not [string]::IsNullOrWhiteSpace($tagVersion)) {
            $resolved = $tagVersion
          } else {
            $resolved = "1.0.${{ github.run_number }}"
          }

          if ($resolved.StartsWith("v")) {
            $resolved = $resolved.Substring(1)
          }

          "app_version=$resolved" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Using portable EXE version: $resolved"

      - name: Build portable EXE
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\Lookr\scripts\build-portable.ps1 -Version "${{ steps.version.outputs.app_version }}" -Runtime "win-x64"

      - name: Upload portable EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: LookrQuickText-Portable-${{ steps.version.outputs.app_version }}-win-x64
          path: |
            Lookr/dist/portable/LookrQuickText-${{ steps.version.outputs.app_version }}-win-x64.exe
            Lookr/dist/portable/LookrQuickText-${{ steps.version.outputs.app_version }}-win-x64.exe.sha256
          if-no-files-found: error
